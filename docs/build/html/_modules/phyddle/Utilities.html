<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>phyddle.Utilities &mdash; phyddle 0.0.4 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/phyddle_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.0.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quick_start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../updates.html">Updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pipeline.html">Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../settings.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../files_types.html">Files &amp; datatypes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer_guide.html">Developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">phyddle</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">phyddle.Utilities</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for phyddle.Utilities</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilities</span>
<span class="sd">===========</span>
<span class="sd">Miscellaneous helper functions phyddle uses for pipeline steps.</span>

<span class="sd">Authors:   Michael Landis, Ammon Thompson</span>
<span class="sd">Copyright: (c) 2023, Michael Landis</span>
<span class="sd">License:   MIT</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># standard packages</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">combinations</span>

<span class="c1"># external packages</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">dendropy</span> <span class="k">as</span> <span class="nn">dp</span>


<span class="c1"># Precision settings</span>
<span class="n">NUM_DIGITS</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">floatmode</span><span class="o">=</span><span class="s1">&#39;maxprec&#39;</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">NUM_DIGITS</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.precision&#39;</span><span class="p">,</span> <span class="n">NUM_DIGITS</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.float_format&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s1">,.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># Tensorflow info messages</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_CPP_MIN_LOG_LEVEL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>  <span class="c1"># or any {&#39;0&#39;, &#39;1&#39;, &#39;2&#39;}</span>

<span class="c1">##################</span>
<span class="c1"># Helper Classes #</span>
<span class="c1">##################</span>

<span class="c1"># model events</span>
<span class="k">class</span> <span class="nc">Event</span><span class="p">:</span>

    <span class="c1"># initialize</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">jx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an event in the model.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx (dict): A dictionary containing the indices of the event.</span>
<span class="sd">            r (float): The rate of the event.</span>
<span class="sd">            n (str): The name of the event.</span>
<span class="sd">            g (str): The reaction group of the event.</span>
<span class="sd">            ix (list): The reaction quantities (reactants) before the event.</span>
<span class="sd">            jx (list): The reaction quantities (products) after the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">if</span> <span class="s1">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;j&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;j&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;k&#39;</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ix</span> <span class="o">=</span> <span class="n">ix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jx</span> <span class="o">=</span> <span class="n">jx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span> <span class="o">=</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; -&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39; + &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jx</span><span class="p">)</span>
        <span class="k">return</span>
        
    <span class="c1"># make print string</span>
    <span class="k">def</span> <span class="nf">make_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a string representation of the event.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The string representation of the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;Event(</span><span class="si">{name}</span><span class="s1">,</span><span class="si">{group}</span><span class="s1">,</span><span class="si">{rate}</span><span class="s1">,</span><span class="si">{idx}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rate</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>        
        <span class="c1">#s += &#39;)&#39;</span>
        <span class="k">return</span> <span class="n">s</span>
    
    <span class="c1"># representation string</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the representation of the event.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The representation of the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_str</span><span class="p">()</span>
    
    <span class="c1"># print string</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the string representation of the event.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The string representation of the event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_str</span><span class="p">()</span>


<span class="c1"># state space</span>
<span class="k">class</span> <span class="nc">States</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lbl2vec</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># state space dictionary (input)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbl2vec</span>      <span class="o">=</span> <span class="n">lbl2vec</span>

        <span class="c1"># basic info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span>        <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">lbl2vec</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span>        <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">lbl2vec</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int2int</span>        <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">))</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int2set</span>        <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="p">[</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span> <span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbl_one</span>        <span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="nb">set</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">))</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_char</span>       <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_states</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lbl_one</span> <span class="p">)</span>

        <span class="c1"># relational info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbl2int</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2int</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbl2set</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2set</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lbl2vec</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec2int</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2int</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec2lbl</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vec2set</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2set</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set2vec</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set2int</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2int</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set2lbl</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="n">k</span><span class="p">):</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2set</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int2vecstr</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span> <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vecstr2int</span> <span class="o">=</span> <span class="p">{</span> <span class="n">v</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2vecstr</span><span class="p">)</span> <span class="p">}</span>
       
        <span class="c1"># done</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">make_str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a string representation of the state space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The string representation of the state space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># state space: {&#39;A&#39;: [1, 0, 0], &#39;B&#39;: [0, 1, 0], &#39;C&#39;: [0, 0, 1], &#39;AB&#39;: [1, 1, 0], &#39;AC&#39;: [1, 0, 1], &#39;BC&#39;: [0, 1, 1], &#39;ABC&#39;: [1, 1, 1]}</span>
        <span class="c1"># string: Statespace(A,0,100;B,1,010;C,2,001;AB,3,110;AC,4,101;BC,5,011;ABC,6,111)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;Statespace(&#39;</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2int</span><span class="p">:</span>
            <span class="c1"># each state in the space is reported as STRING,INT,VECTOR;</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int2int</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">int2vec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
        <span class="k">return</span> <span class="n">s</span>

    <span class="c1"># representation string</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the representation of the state space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The representation of the state space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_str</span><span class="p">()</span>
    <span class="c1"># print string</span>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the string representation of the state space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The string representation of the state space.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_str</span><span class="p">()</span>
    
    <span class="c1"># def make_df(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     ## Probably can delete????</span>
    <span class="c1">#     Creates a DataFrame representation of the state space.</span>

    <span class="c1">#     Returns:</span>
    <span class="c1">#         pandas.DataFrame: The DataFrame representation of the state space.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     df = pd.DataFrame()</span>
    <span class="c1">#     return df</span>



<span class="c1">#-----------------------------------------------------------------------------------------------------------------#</span>

<span class="c1">###################</span>
<span class="c1"># CONFIG LOADER   #</span>
<span class="c1">###################</span>

<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">arg_overwrite</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        config_fn (str): The config file name.</span>
<span class="sd">        arg_overwrite (bool, optional): Whether to overwrite config file settings with arguments. Defaults to True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The loaded configuration.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># use command line sys.argv if no args provided</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># argument parsing</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;phyddle pipeline config&#39;</span><span class="p">)</span> <span class="c1">#,</span>
                                     <span class="c1">#formatter_class=argparse.ArgumentDefaultsHelpFormatter)</span>
    
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--cfg&#39;</span><span class="p">,</span>          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;config_fn&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Config file name&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1">#parser.add_argument(&#39;-f&#39;, &#39;--force&#39;,        action=&#39;store_true&#39;, help=&#39;Arguments override config file settings&#39;)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="s1">&#39;--proj&#39;</span><span class="p">,</span>         <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Project name used as directory across pipeline stages&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="s1">&#39;--step&#39;</span><span class="p">,</span>         <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">,</span> <span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;lrn&#39;</span><span class="p">,</span> <span class="s1">&#39;prd&#39;</span><span class="p">,</span> <span class="s1">&#39;plt&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Pipeline step(s) to apply&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--use_parallel&#39;</span><span class="p">,</span>       <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;use_parallel&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Use parallelization? (recommended)&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num_proc&#39;</span><span class="p">,</span>           <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;num_proc&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;How many cores for multiprocessing? (e.g. 4 uses 4, -2 uses all but 2)&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># directory settings</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sim_dir&#39;</span><span class="p">,</span>            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;sim_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory for raw simulated data&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fmt_dir&#39;</span><span class="p">,</span>            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;fmt_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory for tensor-formatted simulated data&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--net_dir&#39;</span><span class="p">,</span>            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;net_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory for trained networks and predictions&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plt_dir&#39;</span><span class="p">,</span>            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plt_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory for plotted results&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pred_dir&#39;</span><span class="p">,</span>           <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;pred_dir&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Predict results for dataset located in this directory&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--pred_prefix&#39;</span><span class="p">,</span>        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;pred_prefix&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Predict results for this dataset&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># model settings</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--show_models&#39;</span><span class="p">,</span>        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Print all available model types and variants?&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--model_type&#39;</span><span class="p">,</span>         <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;model_type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Model type&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--model_variant&#39;</span><span class="p">,</span>      <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;model_variant&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Model variant&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num_char&#39;</span><span class="p">,</span>           <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;num_char&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of characters&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># simulation settings</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sim_method&#39;</span><span class="p">,</span>         <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;sim_method&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Simulation method&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sim_command&#39;</span><span class="p">,</span>        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;sim_command&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Simulation command (when sim_method==</span><span class="se">\&#39;</span><span class="s1">command</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sim_logging&#39;</span><span class="p">,</span>        <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;sim_logging&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;compress&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Simulation logging style&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--start_idx&#39;</span><span class="p">,</span>          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;start_idx&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Start index for simulation&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--end_idx&#39;</span><span class="p">,</span>            <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;end_idx&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;End index for simulation&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--stop_time&#39;</span><span class="p">,</span>          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;stop_time&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum duration of evolution for each simulation&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--min_num_taxa&#39;</span><span class="p">,</span>       <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;min_num_taxa&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Minimum number of taxa for each simulation&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max_num_taxa&#39;</span><span class="p">,</span>       <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;max_num_taxa&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Maximum number of taxa for each simulation&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># formatting settings</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tree_type&#39;</span><span class="p">,</span>          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tree_type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;extant&#39;</span><span class="p">,</span> <span class="s1">&#39;serial&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Type of tree&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tree_width_cats&#39;</span><span class="p">,</span>    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tree_width_cats&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The phylo-state tensor widths for formatting training datasets, space-delimited&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tree_encode_type&#39;</span><span class="p">,</span>   <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tree_encode_type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;height_only&#39;</span><span class="p">,</span> <span class="s1">&#39;height_brlen&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Method for encoding branch length info in tensor&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--char_encode_type&#39;</span><span class="p">,</span>   <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;char_encode_type&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;one_hot&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Method for encoding character states in tensor&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tensor_format&#39;</span><span class="p">,</span>      <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tensor_format&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Storage format for simulation tensors&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--save_phyenc_csv&#39;</span><span class="p">,</span>    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;save_phyenc_csv&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save encoded phylogenetic tensor encoding to csv?&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># learning settings</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--learn_method&#39;</span><span class="p">,</span>       <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;learn_method&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;param_est&#39;</span><span class="p">,</span> <span class="s1">&#39;model_test&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Learning method&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tree_width&#39;</span><span class="p">,</span>         <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tree_width&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The phylo-state tensor width dataset used for a neural network&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num_epochs&#39;</span><span class="p">,</span>         <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of learning epochs&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch_size&#39;</span><span class="p">,</span>         <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;batch_size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Training batch sizes during learning&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--prop_test&#39;</span><span class="p">,</span>          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;prop_test&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Proportion of data used as test examples (demonstrate trained network performance)&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--prop_validation&#39;</span><span class="p">,</span>    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;prop_validation&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Proportion of data used as validation examples (diagnose network overtraining)&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--prop_calibration&#39;</span><span class="p">,</span>   <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;prop_calibration&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Proportion of data used as calibration examples (calibrate conformal prediction intervals)&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cpi_coverage&#39;</span><span class="p">,</span>       <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;cpi_coverage&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Expected coverage percent for calibrated prediction intervals&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--loss&#39;</span><span class="p">,</span>               <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;loss&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Loss function used as optimization criterion&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--optimizer&#39;</span><span class="p">,</span>          <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;optimizer&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Method used for optimizing neural network&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># prediction settings</span>
    <span class="c1"># ... nothing for now??</span>
    <span class="c1"># plotting settings</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_train_color&#39;</span><span class="p">,</span>   <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plot_train_color&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plotting color for training data elements&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_label_color&#39;</span><span class="p">,</span>   <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plot_label_color&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plotting color for training label elements&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_test_color&#39;</span><span class="p">,</span>    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plot_test_color&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plotting color for test data elements&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_val_color&#39;</span><span class="p">,</span>     <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plot_val_color&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plotting color for validation data elements&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_aux_color&#39;</span><span class="p">,</span>     <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plot_aux_color&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plotting color for auxiliary input data elements&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot_pred_color&#39;</span><span class="p">,</span>    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;plot_pred_color&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Plotting color for prediction data elements&#39;</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>


    <span class="c1"># parse arguments</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    
    <span class="c1"># print models &amp; exit</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">show_models</span><span class="p">:</span>
         <span class="kn">import</span> <span class="nn">ModelLoader</span>
         <span class="n">model_str</span> <span class="o">=</span> <span class="n">ModelLoader</span><span class="o">.</span><span class="n">make_model_registry_str</span><span class="p">()</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">model_str</span><span class="p">)</span>
         <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="c1"># overwrite config_fn is argument passed</span>
    <span class="k">if</span> <span class="n">arg_overwrite</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">config_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config_fn</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">config_fn</span>
    <span class="n">config_fn</span> <span class="o">=</span> <span class="n">config_fn</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span>

    <span class="c1"># config from file</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">config_fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># if args.force == True:</span>
            <span class="c1">#     m.args[var] = x</span>
            <span class="c1"># elif var not in m.args:</span>
            <span class="c1">#     m.args[var] = x</span>
            <span class="n">m</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">m</span>
    
    <span class="c1"># update arguments from defaults, when provided</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;proj&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;use_parallel&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;num_proc&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;sim_dir&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;fmt_dir&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;net_dir&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;plt_dir&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;pred_dir&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;model_type&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;model_variant&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;num_char&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;sim_method&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;sim_command&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;sim_logging&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;start_idx&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;end_idx&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;stop_time&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;min_num_taxa&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;max_num_taxa&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;tree_width&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;save_phyenc_csv&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;tree_width_cats&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;tree_encode_type&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;char_encode_type&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;learn_method&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;num_epochs&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;batch_size&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;prop_test&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;prop_validation&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;prop_calibration&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;cpi_coverage&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;loss&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;optimizer&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;pred_prefix&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;plot_train_color&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;plot_test_color&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;plot_val_color&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;plot_aux_color&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;plot_label_color&#39;</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">overwrite_defaults</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="s1">&#39;plot_pred_color&#39;</span><span class="p">)</span>         

    <span class="c1"># check arguments are valid</span>
    <span class="n">check_args</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>

    <span class="c1"># set steps</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sim&#39;</span><span class="p">,</span> <span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;lrn&#39;</span><span class="p">,</span> <span class="s1">&#39;prd&#39;</span><span class="p">,</span> <span class="s1">&#39;plt&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="n">m</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span> <span class="p">]</span>
    <span class="c1"># return new args</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">args</span>

<span class="k">def</span> <span class="nf">check_args</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>

    <span class="c1"># string values</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">]</span>             <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;sim&#39;</span><span class="p">,</span> <span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;lrn&#39;</span><span class="p">,</span> <span class="s1">&#39;prd&#39;</span><span class="p">,</span> <span class="s1">&#39;plt&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sim_method&#39;</span><span class="p">]</span>        <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sim_logging&#39;</span><span class="p">]</span>       <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;clean&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;compress&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;tree_type&#39;</span><span class="p">]</span>         <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="s1">&#39;extant&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;tree_encode_type&#39;</span><span class="p">]</span>  <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;height_only&#39;</span><span class="p">,</span> <span class="s1">&#39;height_brlen&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;char_encode_type&#39;</span><span class="p">]</span>  <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one_hot&#39;</span><span class="p">,</span> <span class="s1">&#39;integer&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;tensor_format&#39;</span><span class="p">]</span>     <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;hdf5&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;learn_method&#39;</span><span class="p">]</span>      <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;param_est&#39;</span><span class="p">,</span> <span class="s1">&#39;model_test&#39;</span><span class="p">]</span>
    
    <span class="c1"># numerical values</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;start_idx&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;end_idx&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;start_idx&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;end_idx&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;min_num_taxa&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;max_num_taxa&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;min_num_taxa&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;max_num_taxa&#39;</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;num_states&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;num_char&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;num_epochs&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;cpi_coverage&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;cpi_coverage&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;prop_test&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;prop_test&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;prop_validation&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;prop_validation&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;prop_calibration&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;prop_calibration&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">1.</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;tree_width_cats&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;tree_width_cats&#39;</span><span class="p">])):</span>
        <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;tree_width_cats&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;tree_width&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;tree_width_cats&#39;</span><span class="p">]</span>

    <span class="k">return</span>


<span class="c1">#-----------------------------------------------------------------------------------------------------------------#</span>

<span class="c1">###################</span>
<span class="c1"># GENERAL HELPERS #</span>
<span class="c1">###################</span>

<div class="viewcode-block" id="make_symm"><a class="viewcode-back" href="../../developer_guide.html#phyddle.Utilities.make_symm">[docs]</a><span class="k">def</span> <span class="nf">make_symm</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes a matrix symmetric by copying the upper triangle to the lower triangle.</span>

<span class="sd">    Args:</span>
<span class="sd">        m (numpy.ndarray): The input matrix.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The symmetric matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># Extracts the diagonal elements of the matrix</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>  <span class="c1"># Extracts the upper triangle of the matrix</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">m</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># Adds the transposed upper triangle to the original upper triangle</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>  <span class="c1"># Restores the original diagonal elements</span>
    <span class="k">return</span> <span class="n">m</span></div>

<span class="k">def</span> <span class="nf">sort_binary_vectors</span><span class="p">(</span><span class="n">binary_vectors</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sorts a list of binary vectors.</span>

<span class="sd">    The binary vectors are sorted first based on the number of &quot;on&quot; bits, and then from left to right in terms of which bits are &quot;on&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        binary_vectors (List[List[int]]): The list of binary vectors to be sorted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[List[int]]: The sorted list of binary vectors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">count_ones</span><span class="p">(</span><span class="n">binary_vector</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Counts the number of &quot;on&quot; bits in a binary vector.</span>

<span class="sd">        Args:</span>
<span class="sd">            binary_vector (List[int]): The binary vector.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The count of &quot;on&quot; bits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">binary_vector</span><span class="p">)</span>

    <span class="n">sorted_vectors</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">binary_vectors</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">count_ones</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_vectors</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_vectors</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">count_ones</span><span class="p">(</span><span class="n">sorted_vectors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="n">count_ones</span><span class="p">(</span><span class="n">sorted_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sorted_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">!=</span> <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                            <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sorted_vectors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">break</span>

    <span class="k">return</span> <span class="n">sorted_vectors</span>

<div class="viewcode-block" id="powerset"><a class="viewcode-back" href="../../developer_guide.html#phyddle.Utilities.powerset">[docs]</a><span class="k">def</span> <span class="nf">powerset</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates all possible subsets (powerset) of the given iterable.</span>

<span class="sd">    Args:</span>
<span class="sd">        iterable: An iterable object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        generator: A generator that yields each subset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iterable</span><span class="p">)</span>  <span class="c1"># Convert the iterable to a list</span>
    <span class="k">return</span> <span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="find_tree_width"><a class="viewcode-back" href="../../developer_guide.html#phyddle.Utilities.find_tree_width">[docs]</a><span class="k">def</span> <span class="nf">find_tree_width</span><span class="p">(</span><span class="n">num_taxa</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">max_taxa</span><span class="p">:</span><span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds the CPSV width.</span>

<span class="sd">    Returns the smallest suitable compact phylogenetic-state vector</span>
<span class="sd">    representation such that num_taxa &lt;= val for val in max_taxa.</span>
<span class="sd">    Returns 0 if num_taxa == 0.</span>
<span class="sd">    Returns -1 if num_taxa &gt; max_taxa[-1].</span>

<span class="sd">    Args:</span>
<span class="sd">        num_taxa (int): the number of taxa in the raw dataset</span>
<span class="sd">        max_taxa (list[int]):  a list of tree widths for CPSV encoding</span>
<span class="sd">    </span>
<span class="sd">    Returns:</span>
<span class="sd">        int: The smallest suitable tree width encoding</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">num_taxa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">num_taxa</span> <span class="o">&gt;</span> <span class="n">max_taxa</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">max_taxa</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num_taxa</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="c1"># should never call this</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;error in find_tree_width()&#39;</span><span class="p">,</span> <span class="n">num_taxa</span><span class="p">,</span> <span class="n">max_taxa</span><span class="p">)</span></div>
    <span class="c1">#return -2</span>


<span class="k">def</span> <span class="nf">get_num_tree_row</span><span class="p">(</span><span class="n">tree_type</span><span class="p">,</span> <span class="n">tree_encode_type</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">tree_type</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
        <span class="n">num_tree_row</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">tree_type</span> <span class="o">==</span> <span class="s1">&#39;extant&#39;</span><span class="p">:</span>
        <span class="n">num_tree_row</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">tree_encode_type</span> <span class="o">==</span> <span class="s1">&#39;height_only&#39;</span><span class="p">:</span>
        <span class="n">num_tree_row</span> <span class="o">+=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">tree_encode_type</span> <span class="o">==</span> <span class="s1">&#39;height_brlen&#39;</span><span class="p">:</span>
        <span class="n">num_tree_row</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="k">return</span> <span class="n">num_tree_row</span>

<span class="k">def</span> <span class="nf">get_num_char_row</span><span class="p">(</span><span class="n">state_encode_type</span><span class="p">,</span> <span class="n">num_char</span><span class="p">,</span> <span class="n">num_states</span><span class="p">):</span>
        
    <span class="k">if</span> <span class="n">state_encode_type</span> <span class="o">==</span> <span class="s1">&#39;integer&#39;</span><span class="p">:</span>
        <span class="n">num_char_row</span> <span class="o">=</span> <span class="n">num_char</span>
    <span class="k">elif</span> <span class="n">state_encode_type</span> <span class="o">==</span> <span class="s1">&#39;one_hot&#39;</span><span class="p">:</span>
        <span class="n">num_char_row</span> <span class="o">=</span> <span class="n">num_char</span> <span class="o">*</span> <span class="n">num_states</span>

    <span class="k">return</span> <span class="n">num_char_row</span>


<span class="c1">#-----------------------------------------------------------------------------------------------------------------#</span>


<span class="c1">################</span>
<span class="c1"># FILE HELPERS #</span>
<span class="c1">################</span>

<span class="k">def</span> <span class="nf">write_to_file</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Writes a string to a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        s (str): The string to write.</span>
<span class="sd">        fn (str): The file name or path to write the string to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span>


<span class="k">def</span> <span class="nf">read_tree</span><span class="p">(</span><span class="n">tre_fn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads a phylogenetic tree from a file.</span>

<span class="sd">    Args:</span>
<span class="sd">        tre_fn (str): The file name or path of the tree file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dp.Tree or None: The parsed phylogenetic tree object, or None if the tree cannot be read.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the tree file at `tre_fn` does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tre_fn</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not find tree file at </span><span class="si">{</span><span class="n">tre_fn</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">phy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">schema</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;newick&#39;</span><span class="p">,</span> <span class="s1">&#39;nexus&#39;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phy_tmp</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">Tree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">tre_fn</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">phy_tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">phy_tmp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">phy</span> <span class="o">=</span> <span class="n">phy_tmp</span>
    <span class="k">return</span> <span class="n">phy</span>




<span class="c1">#-----------------------------------------------------------------------------------------------------------------#</span>

<span class="c1">#####################</span>
<span class="c1"># FORMAT CONVERTERS #</span>
<span class="c1">#####################</span>


<span class="k">def</span> <span class="nf">convert_nexus_to_array</span><span class="p">(</span><span class="n">dat_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">char_encode_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_states</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">char_encode_type</span> <span class="o">==</span> <span class="s1">&#39;integer&#39;</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">convert_nexus_to_integer_array</span><span class="p">(</span><span class="n">dat_fn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">char_encode_type</span> <span class="o">==</span> <span class="s1">&#39;one_hot&#39;</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">convert_nexus_to_onehot_array</span><span class="p">(</span><span class="n">dat_fn</span><span class="p">,</span> <span class="n">num_states</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="ne">NotImplementedError</span>

    <span class="k">return</span> <span class="n">dat</span>

<span class="k">def</span> <span class="nf">convert_nexus_to_integer_array</span><span class="p">(</span><span class="n">dat_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a NEXUS file to an integer-encoded pandas DataFrame.</span>

<span class="sd">    Reads the NEXUS file specified by `dat_fn`, extracts the data matrix, and constructs a pandas DataFrame where rows represent character states and columns represent taxa.</span>

<span class="sd">    Args:</span>
<span class="sd">        dat_fn (str): The file name or path of the NEXUS file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: The pandas DataFrame representing the data matrix.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the NEXUS file at `dat_fn` does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read file</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="c1">#print(os.getcwd())</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dat_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># process file</span>
    <span class="n">found_matrix</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">num_taxa</span>    <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_char</span>    <span class="o">=</span> <span class="mi">0</span>
    <span class="n">taxon_idx</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="n">taxon_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># purge whitespace</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        
        <span class="c1"># skip lines with comments</span>
        <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># get data dimenions</span>
        <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DIMENSIONS&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;NTAX&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">num_taxa</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s1">&#39;NCHAR&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">num_char</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_char</span><span class="p">,</span> <span class="n">num_taxa</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># entering data matrix</span>
        <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MATRIX&#39;</span><span class="p">:</span>
            <span class="n">found_matrix</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># process data matrix</span>
        <span class="k">if</span> <span class="n">found_matrix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span><span class="p">:</span>
                <span class="n">found_matrix</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1">#print(tok)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">tok</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">taxon_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">dat</span><span class="p">[:,</span><span class="n">taxon_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">state</span> <span class="p">]</span>
                <span class="n">taxon_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># construct data frame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">taxon_names</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">convert_nexus_to_onehot_array</span><span class="p">(</span><span class="n">dat_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">num_states</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a NEXUS file to a one-hot encoded pandas DataFrame.</span>

<span class="sd">    Reads the NEXUS file specified by `dat_fn`, extracts the data matrix, and constructs a pandas DataFrame where rows represent character states and columns represent taxa.</span>

<span class="sd">    Args:</span>
<span class="sd">        dat_fn (str): The file name or path of the NEXUS file.</span>
<span class="sd">        num_states (int, optional): Number of states to one-hot encode. Learned from length of symbols when None. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pd.DataFrame: The pandas DataFrame representing the data matrix.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the NEXUS file at `dat_fn` does not exist.</span>


<span class="sd">    Character state-vector with one-hot encoding</span>
<span class="sd">    Example:</span>
<span class="sd">    Let num_char = 2 and num_state = 3 for states {0, 1, 2}</span>
<span class="sd">                ---------------------</span>
<span class="sd">        Char:   | 0  0  0 | 1  1  1 |</span>
<span class="sd">        State:  | 0  1  2 | 0  1  2 |</span>
<span class="sd">                |---------|---------|</span>
<span class="sd">        Encode: | 0  1  2 | 3  4  5 |</span>
<span class="sd">                ---------------------</span>
<span class="sd">    Taxon with state-vector &quot;20&quot; -&gt; &quot;001100&quot;</span>
<span class="sd">    Taxon with state-vector &quot;12&quot; -&gt; &quot;010001&quot;</span>
<span class="sd">    etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># read file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dat_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># helper variables</span>
    <span class="n">found_matrix</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">num_taxa</span>    <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_char</span>    <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num_one_hot</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">taxon_idx</span>   <span class="o">=</span> <span class="mi">0</span>
    <span class="n">taxon_names</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">#print(&#39;\n&#39;.join(lines))</span>
    <span class="c1"># process file</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="c1"># purge whitespace</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tok</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        
        <span class="c1"># skip lines with comments</span>
        <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;[&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># get data dimenions</span>
        <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;DIMENSIONS&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;NTAX&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">num_taxa</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="s1">&#39;NCHAR&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span>
                    <span class="n">num_char</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">num_one_hot</span> <span class="o">=</span> <span class="n">num_states</span> <span class="o">*</span> <span class="n">num_char</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_one_hot</span><span class="p">,</span> <span class="n">num_taxa</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># entering data matrix</span>
        <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;MATRIX&#39;</span><span class="p">:</span>
            <span class="n">found_matrix</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">continue</span>

        <span class="c1"># process data matrix</span>
        <span class="k">if</span> <span class="n">found_matrix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;;&#39;</span><span class="p">:</span>
                <span class="n">found_matrix</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tok</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># Taxon name</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tok</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">taxon_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c1"># One-hot encoding</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">tok</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">state</span> <span class="p">]</span>
                <span class="c1">#print(v)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                    <span class="c1">#print(&#39;  &#39;,i,j)</span>
                    <span class="n">state_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">num_states</span> <span class="o">+</span> <span class="n">j</span>
                    <span class="c1">#print(state_idx)</span>
                    <span class="n">dat</span><span class="p">[</span><span class="n">state_idx</span><span class="p">,</span><span class="n">taxon_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">taxon_idx</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># construct data frame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">taxon_names</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">convert_phy2dat_nex</span><span class="p">(</span><span class="n">phy_nex_fn</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">int2vec</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a phylogenetic tree in NHX format to a NEXUS file with taxon-state data.</span>

<span class="sd">    Reads the phylogenetic tree file in NHX format specified by `phy_nex_fn` and converts it to a NEXUS file containing taxon-state data. The binary state representations are based on the provided `int2vec` mapping.</span>

<span class="sd">    Args:</span>
<span class="sd">        phy_nex_fn (str): The file name or path of the phylogenetic tree file in NHX format.</span>
<span class="sd">        int2vec (List[int]): The mapping of integer states to binary state vectors.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The NEXUS file content as a string.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the phylogenetic tree file at `phy_nex_fn` does not exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get num regions from size of bit vector</span>
    <span class="n">num_char</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">int2vec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># get tip names and states from NHX tree</span>
    <span class="n">nex_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">phy_nex_fn</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">nex_str</span>  <span class="o">=</span> <span class="n">nex_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">matches</span>  <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="s1">&#39;([0-9]+)\[\&amp;type=&quot;([A-Z]+)&quot;,location=&quot;([0-9]+)&quot;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">nex_str</span><span class="p">)</span>
    <span class="n">num_taxa</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span>
    <span class="n">nex_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># generate taxon-state data</span>
    <span class="c1">#d = {}</span>
    <span class="n">s_state_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
        <span class="n">taxon</span>        <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">state</span>        <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">vec_str</span>      <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">int2vec</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="p">])</span>
        <span class="c1">#d[ taxon ]   = vec_str</span>
        <span class="n">s_state_str</span> <span class="o">+=</span> <span class="n">taxon</span> <span class="o">+</span> <span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">vec_str</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    
    <span class="c1"># build new nexus string</span>
    <span class="n">s</span> <span class="o">=</span> \
<span class="sd">&#39;&#39;&#39;#NEXUS</span>
<span class="sd">Begin DATA;</span>
<span class="sd">Dimensions NTAX={num_taxa} NCHAR={num_char}</span>
<span class="sd">Format MISSING=? GAP=- DATATYPE=STANDARD SYMBOLS=&quot;01&quot;;</span>
<span class="sd">Matrix</span>
<span class="sd">{s_state_str}</span>
<span class="sd">;</span>
<span class="sd">END;</span>
<span class="sd">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_taxa</span><span class="o">=</span><span class="n">num_taxa</span><span class="p">,</span> <span class="n">num_char</span><span class="o">=</span><span class="n">num_char</span><span class="p">,</span> <span class="n">s_state_str</span><span class="o">=</span><span class="n">s_state_str</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">make_prune_phy</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">prune_fn</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prunes a phylogenetic tree by removing non-extant taxa and writes the pruned tree to a file.</span>

<span class="sd">    The function takes a phylogenetic tree `phy` and a file name `prune_fn` as input. It prunes the tree by removing non-extant taxa and writes the pruned tree to the specified file.</span>

<span class="sd">    Args:</span>
<span class="sd">        phy (Tree): The input phylogenetic tree.</span>
<span class="sd">        prune_fn (str): The file name or path to write the pruned tree.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tree or None: The pruned phylogenetic tree if pruning is successful, or None if the pruned tree would have fewer than two leaf nodes (invalid tree).</span>

<span class="sd">    Raises:</span>
<span class="sd">        None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># copy input tree</span>
    <span class="n">phy_</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span>
    <span class="c1"># compute all root-to-node distances</span>
    <span class="n">root_distances</span> <span class="o">=</span> <span class="n">phy_</span><span class="o">.</span><span class="n">calc_node_root_distances</span><span class="p">()</span>
    <span class="c1"># find tree height (max root-to-node distance)</span>
    <span class="n">tree_height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span> <span class="n">root_distances</span> <span class="p">)</span>
    <span class="c1"># create empty dictionary</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># loop through all leaf nodes</span>
    <span class="n">leaf_nodes</span> <span class="o">=</span> <span class="n">phy_</span><span class="o">.</span><span class="n">leaf_nodes</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">nd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">leaf_nodes</span><span class="p">):</span>
        <span class="c1"># convert root-distances to ages</span>
        <span class="n">age</span> <span class="o">=</span> <span class="n">tree_height</span> <span class="o">-</span> <span class="n">nd</span><span class="o">.</span><span class="n">root_distance</span>
        <span class="n">nd</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">add_new</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="n">age</span><span class="p">)</span>
        <span class="c1"># ultrametricize ages for extant taxa</span>
        <span class="k">if</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="n">age</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># store taxon and age in dictionary</span>
        <span class="n">taxon_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">nd</span><span class="o">.</span><span class="n">taxon</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">taxon_name</span> <span class="o">=</span> <span class="n">taxon_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span> <span class="n">taxon_name</span> <span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
    <span class="c1"># determine what to drop</span>
    <span class="n">drop_taxon_labels</span> <span class="o">=</span> <span class="p">[</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">1e-12</span> <span class="p">]</span>
    <span class="c1"># inform user if pruning yields valid tree</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">leaf_nodes</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">drop_taxon_labels</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># prune non-extant taxa</span>
        <span class="n">phy_</span><span class="o">.</span><span class="n">prune_taxa_with_labels</span><span class="p">(</span> <span class="n">drop_taxon_labels</span> <span class="p">)</span>
        <span class="c1"># write pruned tree</span>
        <span class="n">phy_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">prune_fn</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="s1">&#39;newick&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">phy_</span>

<span class="k">def</span> <span class="nf">settings_to_str</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">taxon_category</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert settings dictionary and taxon category to a string representation.</span>

<span class="sd">    This function takes a settings dictionary and a taxon category and converts them into a comma-separated string representation. The resulting string includes the keys and values of the settings dictionary, as well as the taxon category.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings (dict): The settings dictionary.</span>
<span class="sd">        taxon_category (str): The taxon category.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The string representation of the settings and taxon category.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;setting,value</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;model_name,&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;model_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;model_type,&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;replicate_index,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;replicate_index&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39;taxon_category,&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">taxon_category</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">param_dict_to_str</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert parameter dictionary to two string representations.</span>

<span class="sd">    This function takes a parameter dictionary and converts it into two string representations. The resulting strings includes the parameter names, indices, and values. The first representation is column-based, the second representation is row-based.</span>

<span class="sd">    Args:</span>
<span class="sd">        params (dict): The parameter dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple of two strings. The first string represents the parameter values with indices, and the second string represents the parameter names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="s1">&#39;param,i,j,value</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">NUM_DIGITS</span><span class="p">)</span>
                <span class="n">s1</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{k}</span><span class="s1">,</span><span class="si">{i}</span><span class="s1">,</span><span class="si">{i}</span><span class="s1">,</span><span class="si">{v}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">rate</span><span class="p">)</span>
                <span class="n">s2</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{k}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                <span class="n">s3</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">NUM_DIGITS</span><span class="p">)</span>
                    <span class="n">s1</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{k}</span><span class="s1">,</span><span class="si">{i}</span><span class="s1">,</span><span class="si">{j}</span><span class="s1">,</span><span class="si">{v}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">,</span><span class="n">v</span><span class="o">=</span><span class="n">rate</span><span class="p">)</span>
                    <span class="n">s2</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{k}</span><span class="s1">_</span><span class="si">{i}</span><span class="s1">_</span><span class="si">{j}</span><span class="s1">,&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="n">j</span><span class="p">)</span>
                    <span class="n">s3</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>

    <span class="n">s4</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">s3</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">s1</span><span class="p">,</span><span class="n">s4</span>

<span class="k">def</span> <span class="nf">events2df</span><span class="p">(</span><span class="n">events</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of Event objects to a pandas DataFrame.</span>

<span class="sd">    This function takes a list of Event objects and converts it into a pandas DataFrame. Each Event object represents a row in the resulting DataFrame, with the Event attributes mapped to columns.</span>

<span class="sd">    Args:</span>
<span class="sd">        events (list): A list of Event objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: The resulting DataFrame with columns &#39;name&#39;, &#39;group&#39;, &#39;i&#39;, &#39;j&#39;, &#39;k&#39;, &#39;reaction&#39;, and &#39;rate&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;name&#39;</span>     <span class="p">:</span> <span class="p">[</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">],</span>
        <span class="s1">&#39;group&#39;</span>    <span class="p">:</span> <span class="p">[</span> <span class="n">e</span><span class="o">.</span><span class="n">group</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">],</span> 
        <span class="s1">&#39;i&#39;</span>        <span class="p">:</span> <span class="p">[</span> <span class="n">e</span><span class="o">.</span><span class="n">i</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">],</span>
        <span class="s1">&#39;j&#39;</span>        <span class="p">:</span> <span class="p">[</span> <span class="n">e</span><span class="o">.</span><span class="n">j</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">],</span>
        <span class="s1">&#39;k&#39;</span>        <span class="p">:</span> <span class="p">[</span> <span class="n">e</span><span class="o">.</span><span class="n">k</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">],</span>
        <span class="s1">&#39;reaction&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="n">e</span><span class="o">.</span><span class="n">reaction</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">],</span>
        <span class="s1">&#39;rate&#39;</span>     <span class="p">:</span> <span class="p">[</span> <span class="n">e</span><span class="o">.</span><span class="n">rate</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span> <span class="p">]</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">states2df</span><span class="p">(</span><span class="n">states</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a States object to a pandas DataFrame.</span>

<span class="sd">    This function takes a States object and converts it into a pandas DataFrame. The States object contains information about the state space, and the resulting DataFrame has columns &#39;lbl&#39;, &#39;int&#39;, &#39;set&#39;, and &#39;vec&#39;, representing the labels, integer representations, set representations, and vector representations of the states, respectively.</span>

<span class="sd">    Args:</span>
<span class="sd">        states (States): The States object to convert to a DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: The resulting DataFrame with columns &#39;lbl&#39;, &#39;int&#39;, &#39;set&#39;, and &#39;vec&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;lbl&#39;</span> <span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">int2lbl</span><span class="p">,</span>
        <span class="s1">&#39;int&#39;</span> <span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">int2int</span><span class="p">,</span>
        <span class="s1">&#39;set&#39;</span> <span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">int2set</span><span class="p">,</span>
        <span class="s1">&#39;vec&#39;</span> <span class="p">:</span> <span class="n">states</span><span class="o">.</span><span class="n">int2vec</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1"># make matrix with parameter values, lower-bounds, upper-bounds: 3D-&gt;2D</span>
<span class="k">def</span> <span class="nf">make_param_VLU_mtx</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">param_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a parameter matrix to a pandas DataFrame with combined header indices.</span>

<span class="sd">    This function takes a parameter matrix A and a list of parameter names and creates a pandas DataFrame with combined header indices. The resulting DataFrame has columns representing different statistics (value, lower, upper), replicated indices, and parameters. The parameter names and statistics are combined to form the column headers.</span>

<span class="sd">    Args:</span>
<span class="sd">        A (numpy.ndarray): The parameter matrix.</span>
<span class="sd">        param_names (list): A list of parameter names.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: The resulting DataFrame with combined header indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># axis labels</span>
    <span class="n">stat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="s1">&#39;upper&#39;</span><span class="p">]</span>

    <span class="c1"># multiindex</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span> <span class="s1">&#39;rep_idx&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">])</span>
    
    <span class="c1"># flattened data frame</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="n">A</span><span class="o">.</span><span class="n">flatten</span><span class="p">()},</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reorder_levels</span><span class="p">([</span><span class="s1">&#39;param&#39;</span><span class="p">,</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span><span class="s1">&#39;rep_idx&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>

    <span class="c1"># unstack stat and param, so they become combined header indices</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span><span class="s1">&#39;param&#39;</span><span class="p">])</span>
    <span class="c1">#col_names = df.columns</span>

    <span class="n">new_col_names</span> <span class="o">=</span> <span class="p">[</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param_names</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">stat_names</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="p">]</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">new_col_names</span>

    <span class="k">return</span> <span class="n">df</span>

<span class="k">def</span> <span class="nf">make_clean_phyloenc_str</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a numpy array to a clean string representation.</span>

<span class="sd">    This function takes a numpy array `x` and converts it to a clean string representation. The resulting string is obtained by formatting the array with a comma separator, removing the square brackets, and replacing line breaks and unnecessary whitespace characters. The string representation is useful for displaying or saving the array in a clean and readable format.</span>

<span class="sd">    Args:</span>
<span class="sd">        x (numpy.ndarray): The numpy array to convert.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The clean string representation of the numpy array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array2string</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">max_line_width</span><span class="o">=</span><span class="mf">1e200</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e200</span><span class="p">,</span> <span class="n">edgeitems</span><span class="o">=</span><span class="mf">1e200</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">floatmode</span><span class="o">=</span><span class="s1">&#39;maxprec&#39;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[\[\]]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;,\n &#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">clean_scientific_notation</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean up a string representation of a number in scientific notation.</span>

<span class="sd">    This function takes a string `s` representing a number in scientific notation and removes unnecessary characters that indicate zero values. The resulting string represents the number without trailing zeros in the exponent.</span>

<span class="sd">    Args:</span>
<span class="sd">        s (str): The string representation of a number in scientific notation.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: The cleaned up string representation of the number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span> <span class="s1">&#39;\.0+E\+0+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>



<span class="c1">#-----------------------------------------------------------------------------------------------------------------#</span>

<span class="c1">#########################</span>
<span class="c1"># Tensor de/normalizing #</span>
<span class="c1">#########################</span>

<span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">m_sd</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize the data using mean and standard deviation.</span>

<span class="sd">    This function normalizes the input data using the mean and standard deviation. If the `m_sd` parameter is not provided, the function computes the mean and standard deviation of the data and performs normalization. If `m_sd` is provided, it assumes that the mean and standard deviation have already been computed and uses them for normalization.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (numpy.ndarray): The input data to be normalized.</span>
<span class="sd">        m_sd (tuple): A tuple containing the mean and standard deviation. If not provided, the mean and standard deviation will be computed from the data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The normalized data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">m_sd</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sd</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sd</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">sd</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">sd</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">m_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">m_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">m_sd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">m_sd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
    
<span class="k">def</span> <span class="nf">denormalize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">train_mean</span><span class="p">,</span> <span class="n">train_sd</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Denormalize the data using the mean and standard deviation.</span>

<span class="sd">    This function denormalizes the input data using the provided mean and standard deviation. It reverses the normalization process and brings the data back to its original scale.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (numpy.ndarray): The normalized data to be denormalized.</span>
<span class="sd">        train_mean (numpy.ndarray): The mean used for normalization.</span>
<span class="sd">        train_sd (numpy.ndarray): The standard deviation used for normalization.</span>

<span class="sd">    Returns:</span>
<span class="sd">        numpy.ndarray: The denormalized data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">*</span> <span class="n">train_sd</span> <span class="o">+</span> <span class="n">train_mean</span>

<span class="c1">#-----------------------------------------------------------------------------------------------------------------#</span>



<span class="c1"># def convert_table_to_array(dat_fn, sep=&quot;,&quot;):</span>
    
<span class="c1">#     # read file</span>
<span class="c1">#     f = open(dat_fn, &#39;r&#39;)</span>
<span class="c1">#     lines = f.readlines()</span>
<span class="c1">#     f.close()</span>

<span class="c1">#     # process file</span>
<span class="c1">#     num_taxa    = len(lines)</span>
<span class="c1">#     num_char    = 0</span>
<span class="c1">#     taxon_idx   = 0</span>
<span class="c1">#     taxon_names = []</span>
<span class="c1">#     first_taxon = True</span>

<span class="c1">#     for line in lines:</span>
<span class="c1">#         # purge whitespace</span>
<span class="c1">#         line = &#39; &#39;.join(line.split()).rstrip(&#39;\n&#39;)</span>
<span class="c1">#         tok = line.split(sep)</span>
        
<span class="c1">#         # get taxon + state</span>
<span class="c1">#         name = tok[0]</span>
<span class="c1">#         state = tok[1]</span>

<span class="c1">#         # construct matrix based on num char</span>
<span class="c1">#         if first_taxon:</span>
<span class="c1">#             first_taxon = False</span>
<span class="c1">#             num_char = len(state)</span>
<span class="c1">#             dat = np.zeros((num_char, num_taxa), dtype=&#39;int&#39;)</span>

<span class="c1">#         # save taxon name, populate array</span>
<span class="c1">#         taxon_names.append(name)</span>
<span class="c1">#         dat[:,taxon_idx] = [ int(z) for z in state ]</span>
<span class="c1">#         taxon_idx += 1</span>

<span class="c1">#     # construct data frame</span>
<span class="c1">#     # rows: char states</span>
<span class="c1">#     # cols: taxa</span>
<span class="c1">#     df = pd.DataFrame(dat, columns=taxon_names)</span>
    
<span class="c1">#     return df</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>