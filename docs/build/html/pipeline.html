<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pipeline &mdash; phyddle 0.0.5 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Workspace" href="workspace.html" />
    <link rel="prev" title="Configuration" href="configuration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html">
            
              <img src="_static/phyddle_logo.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.0.5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#simulate">Simulate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#format">Format</a></li>
<li class="toctree-l2"><a class="reference internal" href="#train">Train</a></li>
<li class="toctree-l2"><a class="reference internal" href="#estimate">Estimate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#plot">Plot</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="workspace.html">Workspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="formats.html">Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="tricks.html">Tricks</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="updates.html">Updates</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">phyddle</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Pipeline</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/pipeline.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pipeline">
<span id="id1"></span><h1>Pipeline<a class="headerlink" href="#pipeline" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section describes how a standard phyddle pipeline analysis is
configured and how settings determine the behavior of a phyddle analysis.
Visit <a class="reference internal" href="configuration.html#configuration"><span class="std std-ref">Configuration</span></a> to learn how to assign settings for a phyddle
analysis. Visit <a class="reference internal" href="glossary.html#glossary"><span class="std std-ref">Glossary</span></a> to learn more about
how phyddle defines different terms</p>
</div>
<a class="reference internal image-reference" href="_images/phyddle_pipeline.png"><img alt="_images/phyddle_pipeline.png" class="align-right" src="_images/phyddle_pipeline.png" style="width: 358.91999999999996px; height: 383.76px;" /></a>
<p>A phyddle pipeline analysis has five steps: <a class="reference internal" href="#simulate"><span class="std std-ref">Simulate</span></a>, <a class="reference internal" href="#format"><span class="std std-ref">Format</span></a>,
<a class="reference internal" href="#train"><span class="std std-ref">Train</span></a>, <a class="reference internal" href="#estimate"><span class="std std-ref">Estimate</span></a>, and <a class="reference internal" href="#plot"><span class="std std-ref">Plot</span></a>. Standard analyses run all
steps, in order for a single batch of settings. That said, steps can be run
multiple times under different settings and orders, which is useful for
exploratory and advanced analyses. Visit <a class="reference internal" href="tricks.html#tricks"><span class="std std-ref">Tricks</span></a> to learn how to use
phyddle to its fullest potential.</p>
<p>All pipeline steps create output files. All pipeline (except <a class="reference internal" href="#simulate"><span class="std std-ref">Simulate</span></a>)
also require input files corresponding to at least one other pipeline step.
A full phyddle analysis for a <em>project</em> will automatically generate the
input files for downstream pipeline steps and store them in a predictable
<em>project directory</em>.</p>
<p>Users may also elect to use phyddle for only some steps in their analysis, and
produce files for other steps by different means. For example, <a class="reference internal" href="#format"><span class="std std-ref">Format</span></a>
expects to format and combine large numbers of simulated datasets into tensor
formats that can be used for supervised learning with neural networks.
These simulated files can either be generated through phyddle with
the <a class="reference internal" href="#simulate"><span class="std std-ref">Simulate</span></a> step or outside of phyddle entirely.</p>
<p>Below is the project directory structure that a standard phyddle analysis
would use. In general, we assume the project name is <code class="docutils literal notranslate"><span class="pre">example</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Simulate
-<span class="w"> </span>input:<span class="w">   </span>None
-<span class="w"> </span>output:<span class="w">  </span>workspace/simulate/example<span class="w">   </span><span class="c1"># simulated datasets</span>

Format
-<span class="w"> </span>input:<span class="w">   </span>workspace/simulate/example
-<span class="w"> </span>output:<span class="w">  </span>workspace/format/example<span class="w">     </span><span class="c1"># formatted datasets</span>

Train
-<span class="w"> </span>input:<span class="w">   </span>workspace/format/example
-<span class="w"> </span>output:<span class="w">  </span>workspace/train/example<span class="w">      </span><span class="c1"># trained network + results</span>

Estimate
-<span class="w"> </span>input:<span class="w">   </span>workspace/estimate/example<span class="w">   </span><span class="c1"># new (emprical) dataset</span>
<span class="w">           </span>workspace/train/example
-<span class="w"> </span>output:<span class="w">  </span>workspace/estimate/example<span class="w">   </span><span class="c1"># new (empirical) estimates</span>

Plot
-<span class="w"> </span>input:<span class="w">   </span>workspace/format/example
<span class="w">           </span>workspace/train/example
<span class="w">           </span>workspace/estimate/example<span class="w">   </span><span class="c1"># (optional)</span>
-<span class="w"> </span>output:<span class="w">  </span>workspace/plot/example<span class="w">       </span><span class="c1"># analysis figures</span>
</pre></div>
</div>
<section id="simulate">
<span id="id2"></span><h2>Simulate<a class="headerlink" href="#simulate" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="#simulate"><span class="std std-ref">Simulate</span></a> instructs phyddle to simulate your training dataset. Any
simulator that can be called from command-line can be used to generate training
datasets with phyddle. This allows researchers to use their favorite simulator
with phyddle for phylogenetic modeling tasks.</p>
<p>As a worked example, suppose we have an R script called <code class="docutils literal notranslate"><span class="pre">sim_one.R</span></code> containing
the following code</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># load library</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ape</span><span class="p">)</span>

<span class="c1"># gather arguments</span>
<span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">commandArgs</span><span class="p">(</span><span class="n">trailingOnly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># simulated file names</span>
<span class="n">tmp_fn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
<span class="n">phy_fn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">tmp_fn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.tre&quot;</span><span class="p">)</span>
<span class="n">dat_fn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">tmp_fn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.dat.nex&quot;</span><span class="p">)</span>
<span class="n">lbl_fn</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nf">paste0</span><span class="p">(</span><span class="n">tmp_fn</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.param_row.csv&quot;</span><span class="p">)</span>

<span class="c1"># simulation parameters</span>
<span class="n">birth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rexp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="n">death</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">birth</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="n">rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rexp</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="n">max_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">runif</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">10</span><span class="p">)</span>

<span class="c1"># simulate training data</span>
<span class="n">phy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rbdtree</span><span class="p">(</span><span class="n">birth</span><span class="o">=</span><span class="n">birth</span><span class="p">,</span><span class="w"> </span><span class="n">death</span><span class="o">=</span><span class="n">death</span><span class="p">,</span><span class="w"> </span><span class="n">Tmax</span><span class="o">=</span><span class="n">max_time</span><span class="p">)</span>
<span class="n">dat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">rTraitDisc</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">=</span><span class="s">&quot;ER&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">,</span><span class="w"> </span><span class="n">state_labels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="n">dat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dat</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="w">  </span><span class="c1"># re-index states from 1/2 to 0/1</span>

<span class="c1"># collect training labels</span>
<span class="n">lbl_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">birth</span><span class="o">=</span><span class="n">birth</span><span class="p">,</span><span class="w"> </span><span class="n">death</span><span class="o">=</span><span class="n">death</span><span class="p">,</span><span class="w"> </span><span class="n">rate</span><span class="o">=</span><span class="n">rate</span><span class="p">)</span>
<span class="n">lbl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">lbl_vec</span><span class="p">))</span>

<span class="c1"># save training example</span>
<span class="nf">write.tree</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="n">phy_fn</span><span class="p">)</span>
<span class="nf">write.nexus.data</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="n">dat_fn</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="o">=</span><span class="s">&quot;standard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">datablock</span><span class="o">=</span><span class="bp">T</span><span class="p">)</span>
<span class="nf">write.csv</span><span class="p">(</span><span class="n">lbl</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="o">=</span><span class="n">lbl_fn</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="o">=</span><span class="bp">F</span><span class="p">,</span><span class="w"> </span><span class="n">quote</span><span class="o">=</span><span class="bp">F</span><span class="p">)</span>

<span class="c1"># done!</span>
<span class="nf">quit</span><span class="p">()</span>
</pre></div>
</div>
<p>This script has a few important features. First, the simulator is entirely
reponsible for simulating the dataset. Second, the script assumes it will be
provided a runtime argument (<code class="docutils literal notranslate"><span class="pre">args[1]</span></code>) to generate filenames for the training
example. Third, output for the Newick string is stored into a <code class="docutils literal notranslate"><span class="pre">.tre</span></code> file,
for the character matrix data into a <code class="docutils literal notranslate"><span class="pre">.dat.nex</span></code> Nexus file, and for the
training labels into a comma-separated <code class="docutils literal notranslate"><span class="pre">.csv</span></code> file.</p>
<p>Now that we understand thee script, we need to configure phyddle to call it
properly. This is done by setting the <code class="docutils literal notranslate"><span class="pre">sim_command</span></code> argumetn equal to a
command string of the form <code class="docutils literal notranslate"><span class="pre">MY_COMMAND</span> <span class="pre">[MY_COMMAND_ARGUMENTS]</span></code>. During
simulation, phyddle executes the command string against different filepath
locations. More specifically, phyddle will execute the command
<code class="docutils literal notranslate"><span class="pre">MY_COMMAND</span> <span class="pre">[MY_COMMAND_ARGUMENTS]</span> <span class="pre">SIM_PREFIX</span></code>, where <code class="docutils literal notranslate"><span class="pre">SIM_PREFIX</span></code> contains
the beginning of the filepath locating for an individual simulated dataset. As
part of the Simulate step, phyddle will execute the command string against a
range of values of <code class="docutils literal notranslate"><span class="pre">SIM_PREFIX</span></code> generates the complete simulated dataset of
replicated training examples.</p>
<p>The correct <code class="docutils literal notranslate"><span class="pre">sim_command</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;sim_command&#39;</span> <span class="p">:</span> <span class="s1">&#39;Rscript sim_one.R&#39;</span>
</pre></div>
</div>
<p>Assuming <code class="docutils literal notranslate"><span class="pre">sim_dir</span> <span class="pre">=</span> <span class="pre">../workspace/simulate</span></code> and <code class="docutils literal notranslate"><span class="pre">proj</span> <span class="pre">=</span> <span class="pre">my_project</span></code>, phyddle
will execute the commands during simulation</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Rscript<span class="w"> </span>sim_one.R<span class="w"> </span>../workspace/simulate/my_project/sim.0
Rscript<span class="w"> </span>sim_one.R<span class="w"> </span>../workspace/simulate/my_project/sim.1
Rscript<span class="w"> </span>sim_one.R<span class="w"> </span>../workspace/simulate/my_project/sim.2
...
</pre></div>
</div>
<p>for every replication index between <code class="docutils literal notranslate"><span class="pre">start_idx</span></code> and <code class="docutils literal notranslate"><span class="pre">end_idx</span></code>.
In fact, executing <code class="docutils literal notranslate"><span class="pre">Rscript</span> <span class="pre">sim_one.R</span> <span class="pre">../workspace/simulate/my_project/sim.0</span></code> from terminal is the perfect way to validate that your custom simulator is compatible with the phyddle requirements.</p>
</section>
<section id="format">
<span id="id3"></span><h2>Format<a class="headerlink" href="#format" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="#format"><span class="std std-ref">Format</span></a> converts the simulated data for a project into a tensor format
that phyddle uses to train neural networks in the <a class="reference internal" href="#train"><span class="std std-ref">Train</span></a> step.
<a class="reference internal" href="#format"><span class="std std-ref">Format</span></a> performs two main tasks:</p>
<ol class="arabic simple">
<li><p>Encode all individual raw datasets in the simulate project directory into
individual tensor representations</p></li>
<li><p>Combines all the individual tensors into larger, singular tensors to act
as the training dataset</p></li>
</ol>
<p>For each simulated example, <a class="reference internal" href="#format"><span class="std std-ref">Format</span></a> encodes the raw data into two input
tensors and one output tensor:</p>
<ul class="simple">
<li><p>One input tensor is the <strong>phylogenetic-state tensor</strong>. Loosely speaking,
these tensors contain information about terminal taxa across columns and
information about relevant branch lengths and states per taxon across rows.
The phylogenetic-state tensors used by phyddle are based on the compact
bijective ladderized vector (<strong>CBLV</strong>) format of Voznica et al. (2022) and
the compact diversity-reordered vector (<strong>CDV</strong>) format of
Lambert et al. (2022) that incorporates tip states (<strong>CBLV+S</strong> and <strong>CDV+S</strong>)
using the technique described in Thompson et al. (2022).</p></li>
<li><p>The second input is the <strong>auxiliary data tensor</strong>. This tensor contains
summary statistics for the phylogeny and character data matrix and “known”
parameters for the data generating process.</p></li>
<li><p>The output tensor reports <strong>labels</strong> that are generally unknown data
generating parameters to be estimated using the neural network. Depending on
the estimation task, all or only some model parameters might be treated as
labels for training and estimation.</p></li>
</ul>
<p>For most purposes within phyddle, it is safe to think of a tensor as an
n-dimensional array, such as a 1-d vector or a 2-d matrix. The tensor encoding
ensures training examples share a standard shape (e.g. numbers of rows and
columns) that helps the neural network to detect predictable data patterns.
Learn more about the formats of phyddle tensors on the
<a class="reference internal" href="formats.html#tensor-formats"><span class="std std-ref">Tensor Formats</span></a> page.</p>
<p>During tensor-encoding, <a class="reference internal" href="#format"><span class="std std-ref">Format</span></a> processes the tree, data matrix, and
model parameters for each replicate. This is done in parallel, when the
setting <code class="docutils literal notranslate"><span class="pre">use_parallel</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>. Simulated data are processed
using CBLV+S format if <code class="docutils literal notranslate"><span class="pre">tree_type</span></code> is set to <code class="docutils literal notranslate"><span class="pre">'serial'</span></code>. If <code class="docutils literal notranslate"><span class="pre">tree_type</span></code>
is set to <code class="docutils literal notranslate"><span class="pre">'extant'</span></code> then all non-extant taxa are pruned, saved as
<code class="docutils literal notranslate"><span class="pre">pruned.tre</span></code>, then encoded using CDV+S. The size of each tree ($n$) is then
used to identify the largest value in the integer list <code class="docutils literal notranslate"><span class="pre">tree_width_cats</span></code>
it can fit into. For example, if <code class="docutils literal notranslate"><span class="pre">tree_width_cats</span></code> is has the value
<code class="docutils literal notranslate"><span class="pre">[200,</span> <span class="pre">500]</span></code>, then a training example with 207 taxa would be added to a
tensor containing other trees with 201 to 500 taxa. The phylogenetics-state
tensors and auxiliary data tensors are then created. If <code class="docutils literal notranslate"><span class="pre">save_phyenc_csv</span></code>
is set, then individual csv files are saved for each dataset, which is
especially useful for formatting new empirical datasets into an accepted
phyddle format. The <code class="docutils literal notranslate"><span class="pre">param_est</span></code> setting identifies which parameters in
the labels tensor you want to treat as downstream estimation targets. The
<code class="docutils literal notranslate"><span class="pre">param_data</span></code> setting identifies which of those parameters you want to
treat as “known” auxiliary data.</p>
<p>Formatted tensors are then saved to disk either in simple comma-separated
value format or in a compressed HDF5 format. For example, suppose we set
<code class="docutils literal notranslate"><span class="pre">fmt_dir</span></code> to <code class="docutils literal notranslate"><span class="pre">'format'</span></code>, <code class="docutils literal notranslate"><span class="pre">proj</span></code> to <code class="docutils literal notranslate"><span class="pre">'example'</span></code>, and <code class="docutils literal notranslate"><span class="pre">tree_encode</span></code>
to <code class="docutils literal notranslate"><span class="pre">'serial'</span></code>. If we set <code class="docutils literal notranslate"><span class="pre">tensor_format</span></code> to <code class="docutils literal notranslate"><span class="pre">'hdf5'</span></code> it produces:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>workspace/format/example/sim.nt200.hdf5
workspace/format/example/sim.nt500.hdf5
</pre></div>
</div>
<p>or if <code class="docutils literal notranslate"><span class="pre">tensor_format</span> <span class="pre">==</span> <span class="pre">'csv'</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>workspace/format/example/sim.nt200.cdvs.data.csv
workspace/format/example/sim.nt200.labels.csv
workspace/format/example/sim.nt200.summ_stat.csv
workspace/format/example/sim.nt500.cdvs.data.csv
workspace/format/example/sim.nt500.labels.csv
workspace/format/example/sim.nt500.summ_stat.csv
</pre></div>
</div>
<p>These files can then be processed by the <a class="reference internal" href="#train"><span class="std std-ref">Train</span></a> step.</p>
</section>
<section id="train">
<span id="id4"></span><h2>Train<a class="headerlink" href="#train" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="#train"><span class="std std-ref">Train</span></a> builds a neural network and trains it to make model-based
estimates using the training example tensors compiled by the <a class="reference internal" href="#format"><span class="std std-ref">Format</span></a>
step.</p>
<p>The <a class="reference internal" href="#train"><span class="std std-ref">Train</span></a> step performs six main tasks:
1. Load the input training example tensor.
2. Shuffle the input tensor and split it into training, test, validation, and calibration subsets.
3. Build and configure the neural network
4. Use supervised learning to train neural network to make accurate estimates (predictions)
5. Record network training performance to file
6. Save the trained network to file</p>
<p>When data are read in, they are shuffled, with some set aside for test data
(<code class="docutils literal notranslate"><span class="pre">prop_test</span></code>), validation data (<code class="docutils literal notranslate"><span class="pre">prop_val</span></code>), and calibration data
(<code class="docutils literal notranslate"><span class="pre">prop_cal</span></code>), with all remaining data being used for training. A network
must be trained against a particular <code class="docutils literal notranslate"><span class="pre">tree_width</span></code> size (see above).</p>
<p>phyddle uses <a class="reference external" href="https://www.tensorflow.org/">TensorFlow</a> and
<a class="reference external" href="https://keras.io/">Keras</a> to build and train the network. The
phylogenetic-state tensor is processed by convolutional and pooling layers,
while the auxiliary data is processed by dense layers. All input layers are
concatenated then pushed into three branches terminating in output layers
to produce point estimates and upper and lower estimation intervals. Here
is a simplified schematic of the network architecture:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>Simplified network architecture:

                          ,--&gt; Conv1D-normal + Pool --.
    Phylo. Data Tensor --+---&gt; Conv1D-stride + Pool ---\                          ,--&gt; Point estimate
                          &#39;--&gt; Conv1D-dilate + Pool ----+--&gt; Concat + Output(s)--+---&gt; Lower quantile
                                                       /                          &#39;--&gt; Upper quantile
    Aux. Data Tensor   ------&gt; Dense -----------------&#39;
</pre></div>
</div>
<p>Parameter point estimates use a loss function (e.g. <code class="docutils literal notranslate"><span class="pre">loss</span></code> set to <code class="docutils literal notranslate"><span class="pre">'mse'</span></code>;
Tensorflow-supported string or function) while lower/upper quantile estimates
use a pinball loss function (hard-coded).</p>
<p>Calibrated prediction intervals (CPIs) are estimated using the conformalized
quantile regression technique of Romano et al. (2019). CPIs target a
particular estimation interval, e.g. set <code class="docutils literal notranslate"><span class="pre">cpi_coverage</span></code> to <code class="docutils literal notranslate"><span class="pre">0.95</span></code> so
95% of test estimations are expected contain the true simulating value.
More accurate CPIs can be obtained using two-sided conformalized quantile
regression by setting <code class="docutils literal notranslate"><span class="pre">cpi_asymmetric</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code>, though this often
requires larger numbers of calibration examples, determined through
<code class="docutils literal notranslate"><span class="pre">prop_cal</span></code>.</p>
<p>The network is trained iteratively for <code class="docutils literal notranslate"><span class="pre">num_epoch</span></code> training cycles using
batch stochastic gradient descent, with batch sizes given by <code class="docutils literal notranslate"><span class="pre">batch_size</span></code>.
Different optimizers can be used to update network weight and bias
parameters (e.g. <code class="docutils literal notranslate"><span class="pre">optimizer</span> <span class="pre">==</span> <span class="pre">'adam'</span></code>; Tensorflow-supported string
or function). Network performance is also evaluated against validation data
set aside with <code class="docutils literal notranslate"><span class="pre">prop_val</span></code> that are not used for minimizing the loss function.</p>
<p>Training is automatically parallelized using CPUs and GPUs, dependent on
how Tensorflow was installed and system hardware. Output files are stored
in the directory assigned to <code class="docutils literal notranslate"><span class="pre">trn_dir</span></code> in the subdirectory <code class="docutils literal notranslate"><span class="pre">proj</span></code>.</p>
</section>
<section id="estimate">
<span id="id5"></span><h2>Estimate<a class="headerlink" href="#estimate" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="#estimate"><span class="std std-ref">Estimate</span></a> loads a new dataset stored in <code class="docutils literal notranslate"><span class="pre">&lt;est_dir&gt;/&lt;est_proj&gt;</span></code> with
filenames <code class="docutils literal notranslate"><span class="pre">&lt;est_prefix.tre&gt;</span></code> and <code class="docutils literal notranslate"><span class="pre">&lt;est_prefix&gt;.dat.nex</span></code>. This step then
loads a pretrained network and has it estimate new point estimates and
calibrated prediction intervals (CPIs) based on other project settings.
New estimations are then stored into the original <code class="docutils literal notranslate"><span class="pre">&lt;est_dir&gt;/&lt;est_proj&gt;</span></code>.</p>
</section>
<section id="plot">
<span id="id6"></span><h2>Plot<a class="headerlink" href="#plot" title="Permalink to this heading"></a></h2>
<p><a class="reference internal" href="#plot"><span class="std std-ref">Plot</span></a> collects all results from the <a class="reference internal" href="#format"><span class="std std-ref">Format</span></a>, <a class="reference internal" href="#train"><span class="std std-ref">Train</span></a>, and
<a class="reference internal" href="#estimate"><span class="std std-ref">Estimate</span></a> steps to compile a set of useful figures, listed below. When
results from <a class="reference internal" href="#estimate"><span class="std std-ref">Estimate</span></a> are available, the step will integrate it into
other figures to contextualize where that input dataset and estimateed
labels fall with respect to the training dataset.</p>
<p>Plots are stored within <code class="docutils literal notranslate"><span class="pre">&lt;plot_dir&gt;</span></code> in the <code class="docutils literal notranslate"><span class="pre">&lt;plot_proj&gt;</span></code> subdirectory.
Colors for plot elements can be modified with <code class="docutils literal notranslate"><span class="pre">plot_train_color</span></code>,
<code class="docutils literal notranslate"><span class="pre">plot_label_color</span></code>, <code class="docutils literal notranslate"><span class="pre">plot_test_color</span></code>, <code class="docutils literal notranslate"><span class="pre">plot_val_color</span></code>,
<code class="docutils literal notranslate"><span class="pre">plot_aux_color</span></code>, and <code class="docutils literal notranslate"><span class="pre">plot_est_color</span></code> using hex codes or common color
names supported by <a class="reference external" href="https://matplotlib.org/stable/gallery/color/named_colors.html">Matplotlib</a>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">summary.pdf</span></code> contains all figures in a single plot</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">est_CI.pdf</span></code> - simple plot of point estimates and calibrated estimation
intervals for estimation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">histogram_aux.pdf</span></code> - histograms of all values in the auxiliary dataset;
red line for estimateed dataset</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pca_aux.pdf</span></code> - pairwise PCA of all values in the auxiliary dataset;
red dot for estimateed dataset</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">history_.pdf</span></code> - loss performance across epochs for test/validation
datasets for entire network</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">history_&lt;stat_name&gt;.pdf</span></code> - loss, accuracy, error performance across
epochs for test/validation datasets for particular statistics (point est.,
lower CPI, upper CPI)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train_&lt;label_name&gt;.pdf</span></code> - point estimates and calibrated estimation
intervals for training dataset</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_&lt;label_name&gt;.pdf</span></code> - point estimates and calibrated estimation
intervals for test dataset</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">network_architecture.pdf</span></code> - visualization of Tensorflow architecture</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="configuration.html" class="btn btn-neutral float-left" title="Configuration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="workspace.html" class="btn btn-neutral float-right" title="Workspace" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>